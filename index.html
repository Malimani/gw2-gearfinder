<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GW2 Gear Finder</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 2rem;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    header img {
      height: 48px;
    }
    select {
      margin-bottom: 1rem;
      padding: 0.5rem;
      width: 100%;
    }
    .filters {
      margin-bottom: 1rem;
    }
    .filters button {
      margin: 0.25rem;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      background: #fff;
      cursor: pointer;
    }
    .filters button.active {
      background-color: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    .result {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    .result img.icon {
      height: 1.5em;
      vertical-align: middle;
      margin-right: 0.5em;
    }
    .result h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2em;
    }
    .result p {
      margin: 0.25rem 0;
    }
    .result a {
      color: #0066cc;
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="Logo">
    <h1>GW2 Gear Finder <small style="font-size: 0.6em; color: #666;">v1.1.6</small></h1>
  </header>
  <select id="slotSelect">
    <option value="">-- Select Gear Slot --</option>
  </select>
  <select id="attributeSelect" style="display: none;">
    <option value="">-- Select Attribute / Effect --</option>
  </select>

  <div class="filters" id="filters"></div>
  <div id="results"></div>

  <script>
    let gearData;
    let filters = {
      rarity: new Set(),
      weight_class: new Set()
    };

    const attributeMap = {
      "137": "Mighty",
  "138": "Precise",
  "139": "Vital",
  "140": "Resilient",
  "141": "Lingering",
  "142": "Strong",
  "144": "Ravaging",
  "145": "Rejuvenating",
  "146": "Vigorous",
  "147": "Mending",
  "148": "Stout",
  "149": "Hearty",
  "150": "Potent",
  "151": "Penetrating",
  "152": "Honed",
  "153": "Shaman",
  "1071": "Shaman",
  "1097": "Shaman",
  "154": "Rabid",
  "585": "Rabid",
  "594": "Rabid",
  "1042": "Rabid",
  "155": "Cleric",
  "656": "Cleric",
  "661": "Cleric",
  "1044": "Cleric",
  "1076": "Cleric",
  "156": "Magi",
  "1037": "Magi",
  "157": "Valkyrie",
  "1119": "Valkyrie",
  "158": "Knight",
  "657": "Knight",
  "662": "Knight",
  "1051": "Knight",
  "159": "Rampager",
  "658": "Rampager",
  "663": "Rampager",
  "1047": "Rampager",
  "1078": "Rampager",
  "160": "Carrion",
  "1038": "Carrion",
  "1075": "Carrion",
  "161": "Berserker",
  "584": "Berserker",
  "599": "Berserker",
  "1046": "Berserker",
  "1077": "Berserker",
  "162": "Soldier",
  "586": "Soldier",
  "601": "Soldier",
  "1048": "Soldier",
  "175": "Healing",
  "176": "Malign",
  "559": "Celestial",
  "588": "Celestial",
  "593": "Celestial",
  "1052": "Celestial",
  "581": "Dire and Rabid",
  "596": "Dire and Rabid",
  "583": "Cavalier",
  "602": "Cavalier",
  "616": "Cavalier",
  "1050": "Cavalier",
  "591": "Berserker and Valkyrie",
  "600": "Berserker and Valkyrie",
  "592": "Rabid and Apothecary",
  "595": "Rabid and Apothecary",
  "605": "Apothecary",
  "659": "Apothecary",
  "664": "Apothecary",
  "1043": "Apothecary",
  "627": "Giver",
  "628": "Giver",
  "629": "Giver",
  "630": "Giver",
  "631": "Giver",
  "1030": "Giver",
  "1031": "Giver",
  "1070": "Giver",
  "1430": "Giver",
  "660": "Captain",
  "665": "Captain",
  "1041": "Captain",
  "686": "Sentinel",
  "1035": "Sentinel",
  "690": "Settler",
  "693": "Settler",
  "700": "Settler",
  "753": "Assassin",
  "1040": "Assassin",
  "1128": "Assassin",
  "754": "Dire",
  "756": "Dire",
  "1073": "Dire",
  "1114": "Dire",
  "755": "Hunter",
  "799": "Zealot",
  "1163": "Zealot",
  "1011": "Forsaken",
  "1012": "Apostate",
  "1013": "Survivor",
  "1014": "Deserter",
  "1015": "Vagabond",
  "1026": "Nomad",
  "1063": "Nomad",
  "1066": "Nomad",
  "1032": "Bringer",
  "1436": "Bringer",
  "1064": "Sinister",
  "1065": "Sinister",
  "1067": "Sinister",
  "1085": "Trailblazer",
  "1115": "Trailblazer",
  "1229": "Trailblazer",
  "1262": "Trailblazer",
  "1098": "Crusader",
  "1109": "Crusader",
  "1232": "Crusader",
  "1271": "Crusader",
  "1111": "Marauder",
  "1145": "Marauder",
  "1231": "Marauder",
  "1263": "Marauder",
  "1118": "Vigilant",
  "1139": "Vigilant",
  "1228": "Vigilant",
  "1264": "Vigilant",
  "1123": "Minstrel",
  "1134": "Minstrel",
  "1226": "Minstrel",
  "1265": "Minstrel",
  "1125": "Commander",
  "1131": "Commander",
  "1227": "Commander",
  "1267": "Commander",
  "1130": "Viper",
  "1153": "Viper",
  "1224": "Viper",
  "1268": "Viper",
  "1140": "Wanderer",
  "1162": "Wanderer",
  "1225": "Wanderer",
  "1270": "Wanderer",
  "1220": "Seraph",
  "1222": "Seraph",
  "1230": "Seraph",
  "1269": "Seraph",
  "1329": "Grieving",
  "1344": "Grieving",
  "1366": "Grieving",
  "1379": "Grieving",
  "1337": "Marshal",
  "1364": "Marshal",
  "1374": "Marshal",
  "1378": "Marshal",
  "1345": "Harrier",
  "1363": "Harrier",
  "1367": "Harrier",
  "1377": "Harrier",
  "1484": "Plaguedoctor",
  "1486": "Plaguedoctor",
  "1549": "Plaguedoctor",
  "1559": "Plaguedoctor",
  "1538": "Diviner",
  "1539": "Diviner",
  "1556": "Diviner",
  "1566": "Diviner",
  "1681": "Dragon",
  "1687": "Dragon",
  "1691": "Dragon",
  "1697": "Dragon",
  "1686": "Ritualist",
  "1694": "Ritualist",
  "1706": "Ritualist",
  "1717": "Ritualist"
    };

    let attributesLoaded = true;
    const slotSelect = document.getElementById("slotSelect");
    const attributeSelect = document.getElementById("attributeSelect");
    const filtersDiv = document.getElementById("filters");

    fetch("gearData.json")
      .then((res) => res.json())
      .then((data) => {
        gearData = data;
        for (const slot in data) {
          const option = document.createElement("option");
          option.value = slot;
          option.textContent = slot;
          slotSelect.appendChild(option);
        }
        attributeSelect.style.display = 'none';
        attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';
      })
      .catch((err) => {
        console.error("Error loading gear data:", err);
      });

    function renderFilters(items) {
      filtersDiv.innerHTML = "";
      const rarities = new Set();
      const weights = new Set();

      items.forEach(item => {
        if (item.rarity) rarities.add(item.rarity);
        if (item.weight_class) weights.add(item.weight_class);
      });

      if (rarities.size || weights.size) {
        if (rarities.size) {
          rarities.forEach(rarity => {
            const btn = document.createElement("button");
            btn.textContent = rarity;
            btn.className = filters.rarity.has(rarity) ? "active" : "";
            btn.addEventListener("click", () => {
              if (filters.rarity.has(rarity)) {
                filters.rarity.delete(rarity);
              } else {
                filters.rarity.add(rarity);
              }
              renderItems();
              renderFilters(items);
            });
            filtersDiv.appendChild(btn);
          });
        }
        if (weights.size) {
          weights.forEach(weight => {
            const btn = document.createElement("button");
            btn.textContent = weight;
            btn.className = filters.weight_class.has(weight) ? "active" : "";
            btn.addEventListener("click", () => {
              if (filters.weight_class.has(weight)) {
                filters.weight_class.delete(weight);
              } else {
                filters.weight_class.add(weight);
              }
              renderItems();
              renderFilters(items);
            });
            filtersDiv.appendChild(btn);
          });
        }
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset Filters";
        resetBtn.addEventListener("click", () => {
          filters.rarity.clear();
          filters.weight_class.clear();
          renderItems();
          renderFilters(items);
        });
        filtersDiv.appendChild(resetBtn);
      }
    }

    let currentSlot = "";
let currentAttrLabel = "";
    let currentAttr = "";

    function renderItems() {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  if (!currentSlot || !currentAttrLabel || !gearData[currentSlot]) return;

  const allAttrIds = Object.entries(attributeMap)
    .filter(([, label]) => label === currentAttrLabel)
    .map(([id]) => id);

      gearData[currentSlot].forEach((entry) => {
        if (!entry.attributes || !entry.attributes.some(attr => allAttrIds.includes(String(attr)))) return;

        if (filters.rarity.size && !filters.rarity.has(entry.rarity)) return;
        if (filters.weight_class.size && (!entry.weight_class || !filters.weight_class.has(entry.weight_class))) return;

        const div = document.createElement("div");
        div.className = "result";

        const title = document.createElement("h3");
        if (entry.icon) {
          const icon = document.createElement("img");
          icon.src = entry.icon;
          icon.className = "icon";
          title.appendChild(icon);
        }

        const nameSpan = document.createElement("span");
        nameSpan.textContent = `Loading item name...`;
        title.appendChild(nameSpan);

        const meta = document.createElement("span");
        meta.style.fontSize = "0.9em";
        meta.style.color = "#666";
        meta.style.marginLeft = "0.5em";
        meta.textContent = `(${entry.rarity}${entry.weight_class ? ", " + entry.weight_class : ""})`;
        title.appendChild(meta);

        fetch(`https://api.guildwars2.com/v2/items/${entry.name}?lang=en`)
          .then((res) => res.json())
          .then((itemData) => {
            nameSpan.textContent = itemData.name;
          })
          .catch(() => {
            nameSpan.textContent = `Item ID: ${entry.name}`;
          });

        div.appendChild(title);

        const method = document.createElement("p");
        method.innerHTML = `<strong>Method:</strong> ${entry.method}`;
        div.appendChild(method);

        if (entry.description) {
          const desc = document.createElement("p");
          desc.innerHTML = `<strong>Description:</strong> ${entry.description}`;
          div.appendChild(desc);
        }

        const cost = document.createElement("p");
        cost.innerHTML = `<strong>Cost:</strong> loading...`;
        div.appendChild(cost);

        if (entry.link) {
          const link = document.createElement("a");
          link.href = entry.link;
          link.textContent = "More info";
          link.target = "_blank";
          div.appendChild(link);
        }

        resultsDiv.appendChild(div);

        const match = entry.cost.match(/^TP:(\d+)$/);
        if (match) {
          const itemId = match[1];
          fetch(`https://api.guildwars2.com/v2/commerce/prices/${itemId}`)
            .then(res => res.json())
            .then(data => {
              const copper = data.sells.unit_price % 100;
              const silver = Math.floor((data.sells.unit_price / 100) % 100);
              const gold = Math.floor(data.sells.unit_price / 10000);
              cost.innerHTML = `<strong>Cost:</strong> ${gold}<img src='assets/gold.png' style='height:1em;'> ` +
                               `${silver}<img src='assets/silver.png' style='height:1em;'> ` +
                               `${copper}<img src='assets/copper.png' style='height:1em;'>`;
            })
            .catch(() => {
              cost.innerHTML = `<strong>Cost:</strong> (price unavailable)`;
            });
        } else {
          cost.innerHTML = `<strong>Cost:</strong> ${entry.cost}`;
        }
      });
    }

    slotSelect.addEventListener("change", function () {
      currentSlot = this.value;
      attributeSelect.innerHTML = '';
      attributeSelect.style.display = 'none';

      if (!attributesLoaded || !gearData[currentSlot]) return;

      const attrIdToLabel = new Map();
      const labelToId = new Map();

      gearData[currentSlot].forEach(item => {
        (item.attributes || []).forEach(attrId => {
          const id = attrId.toString();
          const label = attributeMap[id] || `Attribute ${id}`;
          if (!labelToId.has(label)) {
            labelToId.set(label, id);
          }
        });
      });

      const sortedLabels = Array.from(labelToId.keys()).sort((a, b) => a.localeCompare(b));

      attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';
      sortedLabels.forEach(label => {
        const option = document.createElement("option");
        option.value = labelToId.get(label);
        option.textContent = label;
        attributeSelect.appendChild(option);
      });

      attributeSelect.style.display = 'block';
      filtersDiv.innerHTML = "";
      document.getElementById("results").innerHTML = "";
    });

    attributeSelect.addEventListener("change", function () {
  const selectedLabel = this.options[this.selectedIndex].textContent;
  currentAttrLabel = selectedLabel;
  filters.rarity.clear();
  filters.weight_class.clear();

  if (currentSlot && currentAttrLabel && gearData[currentSlot]) {
    const allAttrIds = Object.entries(attributeMap)
      .filter(([, label]) => label === currentAttrLabel)
      .map(([id]) => id);

    const filtered = gearData[currentSlot].filter(item =>
      item.attributes && item.attributes.some(attr => allAttrIds.includes(String(attr)))
    );
    renderFilters(filtered);
  }
  renderItems();
    });
  </script>
</body>
</html>
