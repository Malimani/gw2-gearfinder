<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GW2 Gear Finder</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 2rem;
    }
    select {
      margin-bottom: 1rem;
      padding: 0.5rem;
      width: 100%;
    }
    .result {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    .result img.icon {
      height: 1.5em;
      vertical-align: middle;
      margin-right: 0.5em;
    }
    .result h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2em;
    }
    .result p {
      margin: 0.25rem 0;
    }
    .result a {
      color: #0066cc;
    }
  </style>
</head>
<body>
  <h1>GW2 Gear Finder <small style="font-size: 0.6em; color: #666;">v1.0.4</small></h1>
  <select id="slotSelect">
    <option value="">-- Select Gear Slot --</option>
  </select>
  <select id="attributeSelect">
    <option value="">-- Select Attribute / Effect --</option>
  </select>

  <div id="results"></div>

  <script>
    let gearData;
    const attributeMap = {};
    let attributesLoaded = false;

    const slotSelect = document.getElementById("slotSelect");
    const attributeSelect = document.getElementById("attributeSelect");

    fetch("gearData.json")
      .then((res) => res.json())
      .then((data) => {
        gearData = data;
        for (const slot in data) {
          const option = document.createElement("option");
          option.value = slot;
          option.textContent = slot;
          slotSelect.appendChild(option);
        }
      })
      .catch((err) => {
        console.error("Error loading gear data:", err);
      });

    // Fetch and cache attribute names
    fetch("https://api.guildwars2.com/v2/attributes?ids=all&lang=en")
      .then((res) => res.json())
      .then((attrs) => {
        attrs.forEach(attr => {
          attributeMap[attr.id.toString()] = attr.name;
        });
        attributesLoaded = true;
        // Trigger dropdown rebuild if slot was selected
        if (slotSelect.value) {
          const event = new Event("change");
          slotSelect.dispatchEvent(event);
        }
      });
        attributesLoaded = true;

        if (slotSelect.value) {
          const event = new Event('change');
          slotSelect.dispatchEvent(event);
        }
      });

    slotSelect.addEventListener("change", function () {
      const selectedSlot = this.value;
      attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';

      if (!attributesLoaded || !gearData[selectedSlot]) return;

      const attrSet = new Set();
      gearData[selectedSlot].forEach(item => {
        (item.attributes || []).forEach(attrId => attrSet.add(attrId.toString()));
      });

      const sortedAttrIds = Array.from(attrSet).sort((a, b) => {
        const nameA = attributeMap[a] || `Attribute ${a}`;
        const nameB = attributeMap[b] || `Attribute ${b}`;
        return nameA.localeCompare(nameB);
      });

      sortedAttrIds.forEach(id => {
        const option = document.createElement("option");
        option.value = id;
        option.textContent = attributeMap[id] || `Attribute ${id}`;
        attributeSelect.appendChild(option);
      });

      document.getElementById("results").innerHTML = "";
    });

    attributeSelect.addEventListener("change", function () {
      const slot = slotSelect.value;
      const attrId = this.value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (slot && attrId && gearData[slot]) {
        gearData[slot].forEach((entry) => {
          if (!entry.attributes || !entry.attributes.map(String).includes(attrId)) return;

          const div = document.createElement("div");
          div.className = "result";

          const title = document.createElement("h3");
          if (entry.icon) {
            const icon = document.createElement("img");
            icon.src = entry.icon;
            icon.className = "icon";
            title.appendChild(icon);
          }

          const nameSpan = document.createElement("span");
          nameSpan.textContent = `Loading item name...`;
          title.appendChild(nameSpan);

          fetch(`https://api.guildwars2.com/v2/items/${entry.name}?lang=en`)
            .then((res) => res.json())
            .then((itemData) => {
              nameSpan.textContent = itemData.name;
            })
            .catch(() => {
              nameSpan.textContent = `Item ID: ${entry.name}`;
            });

          div.appendChild(title);

          const method = document.createElement("p");
          method.innerHTML = `<strong>Method:</strong> ${entry.method}`;
          div.appendChild(method);

          if (entry.description) {
            const desc = document.createElement("p");
            desc.innerHTML = `<strong>Description:</strong> ${entry.description}`;
            div.appendChild(desc);
          }

          const cost = document.createElement("p");
          cost.innerHTML = `<strong>Cost:</strong> loading...`;
          div.appendChild(cost);

          if (entry.link) {
            const link = document.createElement("a");
            link.href = entry.link;
            link.textContent = "More info";
            link.target = "_blank";
            div.appendChild(link);
          }

          resultsDiv.appendChild(div);

          const match = entry.cost.match(/^TP:(\d+)$/);
          if (match) {
            const itemId = match[1];
            fetch(`https://api.guildwars2.com/v2/commerce/prices/${itemId}`)
              .then(res => res.json())
              .then(data => {
                const copper = data.sells.unit_price % 100;
                const silver = Math.floor((data.sells.unit_price / 100) % 100);
                const gold = Math.floor(data.sells.unit_price / 10000);
                cost.innerHTML = `<strong>Cost:</strong> ${gold}<img src='assets/gold.png' style='height:1em;'> ` +
                                 `${silver}<img src='assets/silver.png' style='height:1em;'> ` +
                                 `${copper}<img src='assets/copper.png' style='height:1em;'>`;
              })
              .catch(() => {
                cost.innerHTML = `<strong>Cost:</strong> (price unavailable)`;
              });
          } else {
            cost.innerHTML = `<strong>Cost:</strong> ${entry.cost}`;
          }
        });
      }
    });
  </script>
</body>
</html>
