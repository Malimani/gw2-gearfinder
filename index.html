<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="assets/favicon.png" type="image/png">
  <title>Good Ways 2 Gear</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 700px;
      width: 100%;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    header img {
      height: 48px;
    }
    header h1 {
      flex: 1;
      min-width: 200px;
      max-width: 100%;
    }
    select {
      margin-bottom: 1rem;
      padding: 0.5rem;
      width: 100%;
      max-width: 700px;
    }
    .filters {
      margin-bottom: 1rem;
    }
    .filters button {
      margin: 0.25rem;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      background: #fff;
      cursor: pointer;
    }
    .filters button.active {
      background-color: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    .result {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    .result img.icon {
      height: 1.5em;
      vertical-align: middle;
      margin-right: 0.5em;
    }
    .result h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2em;
    }
    .result p {
      margin: 0.25rem 0;
    }
    .result a {
      color: #0066cc;
    }
  </style>
</head>
<body>
  <div class="container">
  <header>
    <img src="assets/logo.png" alt="Logo">
    <h1>Good Ways 2 Gear <small style="font-size: 0.6em; color: #666;">v1.1.8</small></h1>
    <p style="margin-top: -1rem; font-size: 0.9em; color: #444;">
      Inspired by <a href="https://wiki.guildwars2.com/wiki/User:Tanetris/So_You_Want_To_Gear_a_Character" target="_blank" style="color: #0066cc; text-decoration: underline;">Tanetris's in depth guide: <em>So You Want To Gear a Character</em></a>
    </p>
  </header>
  <select id="slotSelect">
    <option value="">-- Select Gear Slot --</option>
  </select>
  <select id="attributeSelect" style="display: none;">
    <option value="">-- Select Attribute / Effect --</option>
  </select>

  <div class="filters" id="filters"></div>
  <div id="results"></div>

  <script>
    let gearData;
    let filters = {
      rarity: new Set(),
      weight_class: new Set()
    };

    let attributeMap = {};
fetch("attributeMap.json")
  .then(res => res.json())
  .then(data => {
    attributeMap = data;
    attributesLoaded = true;
  })
  .catch(err => {
    console.error("Error loading attribute map:", err);
  });

    let attributesLoaded = true;
    const slotSelect = document.getElementById("slotSelect");
    const attributeSelect = document.getElementById("attributeSelect");
    const filtersDiv = document.getElementById("filters");

    fetch("gearData.json")
      .then((res) => res.json())
      .then((data) => {
        gearData = data;
        const slotTypeMap = {
  "Helm": "Armor",
  "Shoulders": "Armor",
  "Coat": "Armor",
  "Gloves": "Armor",
  "Leggings": "Armor",
  "Boots": "Armor",
  "Back": "Trinkets",
  "Amulet": "Trinkets",
  "Ring": "Trinkets",
  "Accessory": "Trinkets",
  "Sword": "Weapons",
  "Dagger": "Weapons",
  "Greatsword": "Weapons",
  "Axe": "Weapons",
  "Mace": "Weapons",
  "Staff": "Weapons",
  "Pistol": "Weapons",
  "Rifle": "Weapons",
  "Scepter": "Weapons",
  "Focus": "Weapons",
  "Shield": "Weapons",
  "Torch": "Weapons",
  "Warhorn": "Weapons",
  "Hammer": "Weapons",
  "Shortbow": "Weapons",
  "Longbow": "Weapons",
  "Harpoon Gun": "Weapons",
  "Trident": "Weapons",
  "Spear": "Weapons"
};

const groupedSlots = {};
for (const slot in data) {
  const group = slotTypeMap[slot] || "Other";
  if (!groupedSlots[group]) groupedSlots[group] = [];
  groupedSlots[group].push(slot);
}

for (const group of Object.keys(groupedSlots).sort()) {
  const optgroup = document.createElement("optgroup");
  optgroup.label = group;
  groupedSlots[group].sort().forEach(slot => {
    const option = document.createElement("option");
    option.value = slot;
    option.textContent = slot;
    optgroup.appendChild(option);
  });
  slotSelect.appendChild(optgroup);
}
        }
        attributeSelect.style.display = 'none';
        attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';
      })
      .catch((err) => {
        console.error("Error loading gear data:", err);
      });

    function renderFilters(items) {
      filtersDiv.innerHTML = "";
      const rarities = new Set();
      const weights = new Set();

      items.forEach(item => {
        if (item.rarity) rarities.add(item.rarity);
        if (item.weight_class) weights.add(item.weight_class);
      });

      if (rarities.size || weights.size) {
        if (rarities.size) {
          rarities.forEach(rarity => {
            const btn = document.createElement("button");
            btn.textContent = rarity;
            btn.className = filters.rarity.has(rarity) ? "active" : "";
            btn.addEventListener("click", () => {
              if (filters.rarity.has(rarity)) {
                filters.rarity.delete(rarity);
              } else {
                filters.rarity.add(rarity);
              }
              renderItems();
              renderFilters(items);
            });
            filtersDiv.appendChild(btn);
          });
        }
        if (weights.size) {
          weights.forEach(weight => {
            const btn = document.createElement("button");
            btn.textContent = weight;
            btn.className = filters.weight_class.has(weight) ? "active" : "";
            btn.addEventListener("click", () => {
              if (filters.weight_class.has(weight)) {
                filters.weight_class.delete(weight);
              } else {
                filters.weight_class.add(weight);
              }
              renderItems();
              renderFilters(items);
            });
            filtersDiv.appendChild(btn);
          });
        }
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset Filters";
        resetBtn.addEventListener("click", () => {
          filters.rarity.clear();
          filters.weight_class.clear();
          renderItems();
          renderFilters(items);
        });
        filtersDiv.appendChild(resetBtn);
      }
    }

    let currentSlot = "";
let currentAttrLabel = "";
    let currentAttr = "";

    function renderItems() {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  if (!currentSlot || !currentAttrLabel || !gearData[currentSlot]) return;

  const allAttrIds = Object.entries(attributeMap)
    .filter(([, label]) => label === currentAttrLabel)
    .map(([id]) => id);

      gearData[currentSlot].forEach((entry) => {
        if (!entry.attributes || !entry.attributes.some(attr => allAttrIds.includes(String(attr)))) return;

        if (filters.rarity.size && !filters.rarity.has(entry.rarity)) return;
        if (filters.weight_class.size && (!entry.weight_class || !filters.weight_class.has(entry.weight_class))) return;

        const div = document.createElement("div");
        div.className = "result";

        const title = document.createElement("h3");
        if (entry.icon) {
          const icon = document.createElement("img");
          icon.src = entry.icon;
          icon.className = "icon";
          title.appendChild(icon);
        }

        const nameSpan = document.createElement("span");
        nameSpan.textContent = `Loading item name...`;
        title.appendChild(nameSpan);

        const meta = document.createElement("span");
        meta.style.fontSize = "0.9em";
        meta.style.color = "#666";
        meta.style.marginLeft = "0.5em";
        meta.textContent = `(${entry.rarity}${entry.weight_class ? ", " + entry.weight_class : ""})`;
        title.appendChild(meta);

        fetch(`https://api.guildwars2.com/v2/items/${entry.name}?lang=en`)
          .then((res) => res.json())
          .then((itemData) => {
            nameSpan.textContent = itemData.name;
          })
          .catch(() => {
            nameSpan.textContent = `Item ID: ${entry.name}`;
          });

        div.appendChild(title);

        const method = document.createElement("p");
        method.innerHTML = `<strong>Method:</strong> ${entry.method}`;
        div.appendChild(method);

        if (entry.description) {
          const desc = document.createElement("p");
          desc.innerHTML = `<strong>Description:</strong> ${entry.description}`;
          div.appendChild(desc);
        }

        const cost = document.createElement("p");
        cost.innerHTML = `<strong>Cost:</strong> loading...`;
        div.appendChild(cost);

        if (entry.link) {
          const link = document.createElement("a");
          link.href = entry.link;
          link.textContent = "More info";
          link.target = "_blank";
          div.appendChild(link);
        }

        resultsDiv.appendChild(div);

        const match = entry.cost.match(/^TP:(\d+)$/);
        if (match) {
          const itemId = match[1];
          fetch(`https://api.guildwars2.com/v2/commerce/prices/${itemId}`)
            .then(res => res.json())
            .then(data => {
              const copper = data.sells.unit_price % 100;
              const silver = Math.floor((data.sells.unit_price / 100) % 100);
              const gold = Math.floor(data.sells.unit_price / 10000);
              cost.innerHTML = `<strong>Cost:</strong> ${gold}<img src='assets/gold.png' style='height:1em;'> ` +
                               `${silver}<img src='assets/silver.png' style='height:1em;'> ` +
                               `${copper}<img src='assets/copper.png' style='height:1em;'>`;
            })
            .catch(() => {
              cost.innerHTML = `<strong>Cost:</strong> (price unavailable)`;
            });
        } else {
          cost.innerHTML = `<strong>Cost:</strong> ${entry.cost}`;
        }
      });
    }

    slotSelect.addEventListener("change", function () {
      currentSlot = this.value;
      attributeSelect.innerHTML = '';
      attributeSelect.style.display = 'none';

      if (!attributesLoaded || !gearData[currentSlot]) return;

      const seenLabels = new Set();
const validOptions = [];
const unknownOptions = [];

attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';

const attrIdsInSlot = new Set();
gearData[currentSlot].forEach(item => {
  (item.attributes || []).forEach(attrId => attrIdsInSlot.add(attrId.toString()));
});

attrIdsInSlot.forEach(id => {
  const label = attributeMap[id];
  const option = document.createElement("option");
  option.value = id;

  if (label) {
    if (!seenLabels.has(label)) {
      seenLabels.add(label);
      option.textContent = label;
      validOptions.push(option);
    }
  } else {
    option.textContent = `Attribute ${id}`;
    option.disabled = true;
    option.style.color = "#aaa";
    unknownOptions.push(option);
  }
});

[...validOptions.sort((a, b) => a.textContent.localeCompare(b.textContent)),
 ...unknownOptions.sort((a, b) => a.textContent.localeCompare(b.textContent))]
.forEach(option => attributeSelect.appendChild(option));


      

      attributeSelect.style.display = 'block';
      filtersDiv.innerHTML = "";
      document.getElementById("results").innerHTML = "";
    });

    attributeSelect.addEventListener("change", function () {
  const selectedLabel = this.options[this.selectedIndex].textContent;
  currentAttrLabel = selectedLabel;
  filters.rarity.clear();
  filters.weight_class.clear();

  if (currentSlot && currentAttrLabel && gearData[currentSlot]) {
    const allAttrIds = Object.entries(attributeMap)
      .filter(([, label]) => label === currentAttrLabel)
      .map(([id]) => id);

    const filtered = gearData[currentSlot].filter(item =>
      item.attributes && item.attributes.some(attr => allAttrIds.includes(String(attr)))
    );
    renderFilters(filtered);
  }
  renderItems();
    });
  </script>
      <footer style="margin-top: 3rem; font-size: 0.8em; color: #777; text-align: center;">
      <p>
        <a href="impressum.html">Impressum</a> |
        <a href="datenschutz.html">Datenschutz</a> |
        Fan project â€“ not affiliated with ArenaNet
      </p>
    </footer>
  </div>
</body>
</html>
