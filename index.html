<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GW2 Gear Finder</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 700px;
      width: 100%;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    header img {
      height: 48px;
    }
    select {
      margin-bottom: 1rem;
      padding: 0.5rem;
      width: 100%;
      max-width: 400px;
    }
    .filters {
      margin-bottom: 1rem;
    }
    .filters button {
      margin: 0.25rem;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      background: #fff;
      cursor: pointer;
    }
    .filters button.active {
      background-color: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    .result {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    .result img.icon {
      height: 1.5em;
      vertical-align: middle;
      margin-right: 0.5em;
    }
    .result h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2em;
    }
    .result p {
      margin: 0.25rem 0;
    }
    .result a {
      color: #0066cc;
    }
  </style>
</head>
<body>
  <div class="container">
  <header>
    <img src="assets/logo.png" alt="Logo">
    <h1>GW2 Gear Finder <small style="font-size: 0.6em; color: #666;">v1.1.6</small></h1>
  </header>
  <select id="slotSelect">
    <option value="">-- Select Gear Slot --</option>
  </select>
  <select id="attributeSelect" style="display: none;">
    <option value="">-- Select Attribute / Effect --</option>
  </select>

  <div class="filters" id="filters"></div>
  <div id="results"></div>

  <script>
    let gearData;
    let filters = {
      rarity: new Set(),
      weight_class: new Set()
    };

    let attributeMap = {};
fetch("attributeMap.json")
  .then(res => res.json())
  .then(data => {
    attributeMap = data;
    attributesLoaded = true;
  })
  .catch(err => {
    console.error("Error loading attribute map:", err);
  });

    let attributesLoaded = true;
    const slotSelect = document.getElementById("slotSelect");
    const attributeSelect = document.getElementById("attributeSelect");
    const filtersDiv = document.getElementById("filters");

    fetch("gearData.json")
      .then((res) => res.json())
      .then((data) => {
        gearData = data;
        for (const slot in data) {
          const option = document.createElement("option");
          option.value = slot;
          option.textContent = slot;
          slotSelect.appendChild(option);
        }
        attributeSelect.style.display = 'none';
        attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';
      })
      .catch((err) => {
        console.error("Error loading gear data:", err);
      });

    function renderFilters(items) {
      filtersDiv.innerHTML = "";
      const rarities = new Set();
      const weights = new Set();

      items.forEach(item => {
        if (item.rarity) rarities.add(item.rarity);
        if (item.weight_class) weights.add(item.weight_class);
      });

      if (rarities.size || weights.size) {
        if (rarities.size) {
          rarities.forEach(rarity => {
            const btn = document.createElement("button");
            btn.textContent = rarity;
            btn.className = filters.rarity.has(rarity) ? "active" : "";
            btn.addEventListener("click", () => {
              if (filters.rarity.has(rarity)) {
                filters.rarity.delete(rarity);
              } else {
                filters.rarity.add(rarity);
              }
              renderItems();
              renderFilters(items);
            });
            filtersDiv.appendChild(btn);
          });
        }
        if (weights.size) {
          weights.forEach(weight => {
            const btn = document.createElement("button");
            btn.textContent = weight;
            btn.className = filters.weight_class.has(weight) ? "active" : "";
            btn.addEventListener("click", () => {
              if (filters.weight_class.has(weight)) {
                filters.weight_class.delete(weight);
              } else {
                filters.weight_class.add(weight);
              }
              renderItems();
              renderFilters(items);
            });
            filtersDiv.appendChild(btn);
          });
        }
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset Filters";
        resetBtn.addEventListener("click", () => {
          filters.rarity.clear();
          filters.weight_class.clear();
          renderItems();
          renderFilters(items);
        });
        filtersDiv.appendChild(resetBtn);
      }
    }

    let currentSlot = "";
let currentAttrLabel = "";
    let currentAttr = "";

    function renderItems() {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  if (!currentSlot || !currentAttrLabel || !gearData[currentSlot]) return;

  const allAttrIds = Object.entries(attributeMap)
    .filter(([, label]) => label === currentAttrLabel)
    .map(([id]) => id);

      gearData[currentSlot].forEach((entry) => {
        if (!entry.attributes || !entry.attributes.some(attr => allAttrIds.includes(String(attr)))) return;

        if (filters.rarity.size && !filters.rarity.has(entry.rarity)) return;
        if (filters.weight_class.size && (!entry.weight_class || !filters.weight_class.has(entry.weight_class))) return;

        const div = document.createElement("div");
        div.className = "result";

        const title = document.createElement("h3");
        if (entry.icon) {
          const icon = document.createElement("img");
          icon.src = entry.icon;
          icon.className = "icon";
          title.appendChild(icon);
        }

        const nameSpan = document.createElement("span");
        nameSpan.textContent = `Loading item name...`;
        title.appendChild(nameSpan);

        const meta = document.createElement("span");
        meta.style.fontSize = "0.9em";
        meta.style.color = "#666";
        meta.style.marginLeft = "0.5em";
        meta.textContent = `(${entry.rarity}${entry.weight_class ? ", " + entry.weight_class : ""})`;
        title.appendChild(meta);

        fetch(`https://api.guildwars2.com/v2/items/${entry.name}?lang=en`)
          .then((res) => res.json())
          .then((itemData) => {
            nameSpan.textContent = itemData.name;
          })
          .catch(() => {
            nameSpan.textContent = `Item ID: ${entry.name}`;
          });

        div.appendChild(title);

        const method = document.createElement("p");
        method.innerHTML = `<strong>Method:</strong> ${entry.method}`;
        div.appendChild(method);

        if (entry.description) {
          const desc = document.createElement("p");
          desc.innerHTML = `<strong>Description:</strong> ${entry.description}`;
          div.appendChild(desc);
        }

        const cost = document.createElement("p");
        cost.innerHTML = `<strong>Cost:</strong> loading...`;
        div.appendChild(cost);

        if (entry.link) {
          const link = document.createElement("a");
          link.href = entry.link;
          link.textContent = "More info";
          link.target = "_blank";
          div.appendChild(link);
        }

        resultsDiv.appendChild(div);

        const match = entry.cost.match(/^TP:(\d+)$/);
        if (match) {
          const itemId = match[1];
          fetch(`https://api.guildwars2.com/v2/commerce/prices/${itemId}`)
            .then(res => res.json())
            .then(data => {
              const copper = data.sells.unit_price % 100;
              const silver = Math.floor((data.sells.unit_price / 100) % 100);
              const gold = Math.floor(data.sells.unit_price / 10000);
              cost.innerHTML = `<strong>Cost:</strong> ${gold}<img src='assets/gold.png' style='height:1em;'> ` +
                               `${silver}<img src='assets/silver.png' style='height:1em;'> ` +
                               `${copper}<img src='assets/copper.png' style='height:1em;'>`;
            })
            .catch(() => {
              cost.innerHTML = `<strong>Cost:</strong> (price unavailable)`;
            });
        } else {
          cost.innerHTML = `<strong>Cost:</strong> ${entry.cost}`;
        }
      });
    }

    slotSelect.addEventListener("change", function () {
      currentSlot = this.value;
      attributeSelect.innerHTML = '';
      attributeSelect.style.display = 'none';

      if (!attributesLoaded || !gearData[currentSlot]) return;

      const attrIdToLabel = new Map();
      const labelToId = new Map();

      gearData[currentSlot].forEach(item => {
        (item.attributes || []).forEach(attrId => {
          const id = attrId.toString();
          const label = attributeMap[id] || `Attribute ${id}`;
          if (!labelToId.has(label)) {
            labelToId.set(label, id);
          }
        });
      });

      const sortedLabels = Array.from(labelToId.keys()).sort((a, b) => a.localeCompare(b));

      attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';
      sortedLabels.forEach(label => {
        const option = document.createElement("option");
        option.value = labelToId.get(label);
        option.textContent = label;
        attributeSelect.appendChild(option);
      });

      attributeSelect.style.display = 'block';
      filtersDiv.innerHTML = "";
      document.getElementById("results").innerHTML = "";
    });

    attributeSelect.addEventListener("change", function () {
  const selectedLabel = this.options[this.selectedIndex].textContent;
  currentAttrLabel = selectedLabel;
  filters.rarity.clear();
  filters.weight_class.clear();

  if (currentSlot && currentAttrLabel && gearData[currentSlot]) {
    const allAttrIds = Object.entries(attributeMap)
      .filter(([, label]) => label === currentAttrLabel)
      .map(([id]) => id);

    const filtered = gearData[currentSlot].filter(item =>
      item.attributes && item.attributes.some(attr => allAttrIds.includes(String(attr)))
    );
    renderFilters(filtered);
  }
  renderItems();
    });
  </script>
  </div>
</body>
</html>
