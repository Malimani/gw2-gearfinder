<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="assets/favicon.png" type="image/png">
  <title>Good Ways 2 Gear</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 700px;
      width: 100%;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    header img {
      height: 48px;
    }
    header h1 {
      flex: 1;
      min-width: 200px;
      max-width: 100%;
    }
    select {
      margin-bottom: 1rem;
      padding: 0.5rem;
      width: 100%;
      max-width: 700px;
    }
    .filters {
      margin-bottom: 1rem;
    }
    .filters button {
      margin: 0.25rem;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      background: #fff;
      cursor: pointer;
    }
    .filters button.active {
      background-color: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    .result {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    .result img.icon {
      height: 1.5em;
      vertical-align: middle;
      margin-right: 0.5em;
    }
    .result h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2em;
    }
    .result p {
      margin: 0.25rem 0;
    }
    .result a {
      color: #0066cc;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="assets/logo.png" alt="Logo">
      <h1>Good Ways 2 Gear <small style="font-size: 0.6em; color: #666;">v1.2.0</small></h1>
      <p style="margin-top: -1rem; font-size: 0.9em; color: #444;">
        Inspired by <a href="https://wiki.guildwars2.com/wiki/User:Tanetris/So_You_Want_To_Gear_a_Character" target="_blank" style="color: #0066cc; text-decoration: underline;">Tanetris's in depth guide: <em>So You Want To Gear a Character</em></a>
      </p>
    </header>

    <select id="slotSelect">
      <option value="">-- Select Gear Slot --</option>
    </select>
    <select id="attributeSelect" style="display: none;"></select>
    <div class="filters" id="filters"></div>
    <div id="results"></div>

    <footer style="margin-top: 3rem; font-size: 0.8em; color: #777; text-align: center;">
      <p>
        <a href="impressum.html">Impressum</a> |
        <a href="datenschutz.html">Datenschutz</a> |
        Fan project â€“ not affiliated with ArenaNet
      </p>
    </footer>
  </div>

  <script>
    const slotSelect = document.getElementById("slotSelect");
    const attributeSelect = document.getElementById("attributeSelect");
    const filtersDiv = document.getElementById("filters");
    const resultsDiv = document.getElementById("results");

    let gearData = {};
    let attributeMap = {};
    let filters = { rarity: new Set(), weight_class: new Set() };
    let currentSlot = "";
    let currentAttrLabel = "";

    const slotTypeMap = {
      "Helm": "Armor", "Shoulders": "Armor", "Coat": "Armor", "Gloves": "Armor", "Leggings": "Armor", "Boots": "Armor",
      "Back": "Trinkets", "Amulet": "Trinkets", "Ring": "Trinkets", "Accessory": "Trinkets",
      "Sword": "Weapons", "Dagger": "Weapons", "Greatsword": "Weapons", "Axe": "Weapons", "Mace": "Weapons",
      "Staff": "Weapons", "Pistol": "Weapons", "Rifle": "Weapons", "Scepter": "Weapons", "Focus": "Weapons",
      "Shield": "Weapons", "Torch": "Weapons", "Warhorn": "Weapons", "Hammer": "Weapons",
      "Shortbow": "Weapons", "Longbow": "Weapons", "Harpoon Gun": "Weapons", "Trident": "Weapons", "Spear": "Weapons"
    };

    async function initialize() {
      try {
        const [attrRes, gearRes] = await Promise.all([
          fetch("attributeMap.json"),
          fetch("gearData.json")
        ]);
        attributeMap = await attrRes.json();
        gearData = await gearRes.json();
        buildSlotDropdown();
      } catch (err) {
        console.error("Initialization error:", err);
      }
    }

    function buildSlotDropdown() {
      const groupedSlots = {};
      for (const slot in gearData) {
        const group = slotTypeMap[slot] || "Other";
        if (!groupedSlots[group]) groupedSlots[group] = [];
        groupedSlots[group].push(slot);
      }
      for (const group of Object.keys(groupedSlots).sort()) {
        const optgroup = document.createElement("optgroup");
        optgroup.label = group;
        groupedSlots[group].sort().forEach(slot => {
          const option = document.createElement("option");
          option.value = slot;
          option.textContent = slot;
          optgroup.appendChild(option);
        });
        slotSelect.appendChild(optgroup);
      }
    }

    function buildAttributeDropdown(slot) {
      const seenLabels = new Set();
      const validOptions = [];
      const unknownOptions = [];
      attributeSelect.innerHTML = '<option value="">-- Select Attribute / Effect --</option>';
      const attrIds = new Set();
      gearData[slot].forEach(item => (item.attributes || []).forEach(id => attrIds.add(id.toString())));

      attrIds.forEach(id => {
        const label = attributeMap[id];
        const option = document.createElement("option");
        option.value = id;
        if (label) {
          if (!seenLabels.has(label)) {
            seenLabels.add(label);
            option.textContent = label;
            validOptions.push(option);
          }
        } else {
          option.textContent = `Attribute ${id}`;
          option.disabled = true;
          option.style.color = "#aaa";
          unknownOptions.push(option);
        }
      });

      [...validOptions.sort((a, b) => a.textContent.localeCompare(b.textContent)),
       ...unknownOptions.sort((a, b) => a.textContent.localeCompare(b.textContent))]
        .forEach(option => attributeSelect.appendChild(option));

      attributeSelect.style.display = 'block';
    }

    function renderFilters(items) {
      filtersDiv.innerHTML = "";
      const rarities = new Set();
      const weights = new Set();
      items.forEach(item => {
        if (item.rarity) rarities.add(item.rarity);
        if (item.weight_class) weights.add(item.weight_class);
      });

      const createButton = (label, type) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.className = filters[type].has(label) ? "active" : "";
        btn.addEventListener("click", () => {
          if (filters[type].has(label)) filters[type].delete(label);
          else filters[type].add(label);
          renderItems();
          renderFilters(items);
        });
        return btn;
      };

      rarities.forEach(r => filtersDiv.appendChild(createButton(r, "rarity")));
      weights.forEach(w => filtersDiv.appendChild(createButton(w, "weight_class")));

      if (rarities.size || weights.size) {
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset Filters";
        resetBtn.addEventListener("click", () => {
          filters.rarity.clear();
          filters.weight_class.clear();
          renderItems();
          renderFilters(items);
        });
        filtersDiv.appendChild(resetBtn);
      }
    }

    function renderItems() {
      resultsDiv.innerHTML = "";
      if (!currentSlot || !gearData[currentSlot]) return;

      const attrIds = Object.entries(attributeMap)
        .filter(([, label]) => label.trim() === currentAttrLabel.trim())
        .map(([id]) => id);

      gearData[currentSlot].forEach(entry => {
        console.log("Checking entry with ID:", entry.name);
        console.log("Current attribute label:", currentAttrLabel);
        console.log("Matching attribute IDs:", attrIds);
        if (currentAttrLabel && (!entry.attributes || !entry.attributes.some(id => attrIds.includes(String(id))))) return;
        if (filters.rarity.size && !filters.rarity.has(entry.rarity)) return;
        if (filters.weight_class.size && (!entry.weight_class || !filters.weight_class.has(entry.weight_class))) return;

        const div = document.createElement("div");
        div.className = "result";
        const title = document.createElement("h3");

        if (entry.icon) {
          const icon = document.createElement("img");
          icon.src = entry.icon;
          icon.className = "icon";
          title.appendChild(icon);
        }

        const nameSpan = document.createElement("span");
        nameSpan.textContent = `Loading item name...`;
        title.appendChild(nameSpan);

        const meta = document.createElement("span");
        meta.style.fontSize = "0.9em";
        meta.style.color = "#666";
        meta.style.marginLeft = "0.5em";
        meta.textContent = `(${entry.rarity}${entry.weight_class ? ", " + entry.weight_class : ""})`;
        title.appendChild(meta);

        const itemId = parseInt(entry.name);
        if (!isNaN(itemId)) {
          fetch(`https://api.guildwars2.com/v2/items/${itemId}?lang=en`)
          .then(res => res.json())
          .then(data => {
            if (data && data.name) {
              nameSpan.textContent = data.name;
            } else {
              nameSpan.textContent = `Item ID: ${entry.name}`;
            }
          })
          .catch(() => nameSpan.textContent = `Item ID: ${entry.name}`);
        } else {
          nameSpan.textContent = entry.name;
        }

        div.appendChild(title);
        div.innerHTML += `<p><strong>Method:</strong> ${entry.method}</p>`;
        if (entry.description) div.innerHTML += `<p><strong>Description:</strong> ${entry.description}</p>`;

        const cost = document.createElement("p");
        cost.innerHTML = `<strong>Cost:</strong> loading...`;
        div.appendChild(cost);

        if (entry.link) {
          const link = document.createElement("a");
          link.href = entry.link;
          link.textContent = "More info";
          link.target = "_blank";
          div.appendChild(link);
        }

        resultsDiv.appendChild(div);

        const match = entry.cost.match(/^TP:(\d+)$/);
        if (match) {
          fetch(`https://api.guildwars2.com/v2/commerce/prices/${match[1]}`)
            .then(res => res.json())
            .then(data => {
              const copper = data.sells.unit_price % 100;
              const silver = Math.floor((data.sells.unit_price / 100) % 100);
              const gold = Math.floor(data.sells.unit_price / 10000);
              cost.innerHTML = `<strong>Cost:</strong> ${gold}<img src='assets/gold.png' style='height:1em;'> ${silver}<img src='assets/silver.png' style='height:1em;'> ${copper}<img src='assets/copper.png' style='height:1em;'>`;
            })
            .catch(() => cost.innerHTML = `<strong>Cost:</strong> (price unavailable)`);
        } else {
          cost.innerHTML = `<strong>Cost:</strong> ${entry.cost}`;
        }
      });
    }

    slotSelect.addEventListener("change", () => {
      currentSlot = slotSelect.value;
      currentAttrLabel = "";
      attributeSelect.innerHTML = '';
      filtersDiv.innerHTML = "";
      resultsDiv.innerHTML = "";

      if (gearData[currentSlot]) {
        buildAttributeDropdown(currentSlot);
      }
    });

    attributeSelect.addEventListener("change", () => {
      const selectedLabel = attributeSelect.options[attributeSelect.selectedIndex].textContent;
      currentAttrLabel = selectedLabel;
      filters.rarity.clear();
      filters.weight_class.clear();

      if (currentSlot && currentAttrLabel && gearData[currentSlot]) {
        const attrIds = Object.entries(attributeMap)
          .filter(([, label]) => label === currentAttrLabel)
          .map(([id]) => id);

        const filtered = gearData[currentSlot].filter(item =>
          item.attributes && item.attributes.some(attr => attrIds.includes(String(attr)))
        );
        renderFilters(filtered);
        renderItems();
      }
    });

    initialize();
  </script>
</body>
</html>
