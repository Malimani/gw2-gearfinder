<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GW2 Gear Admin Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f8f8f8;
      padding: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
    }
    pre {
      background: #eee;
      padding: 1rem;
      margin-top: 2rem;
      white-space: pre-wrap;
    }
    #iconPreview {
      margin-top: 0.5rem;
      max-width: 64px;
      height: auto;
      vertical-align: middle;
    }
    #itemNameDisplay {
      display: inline-block;
      margin-left: 0.5rem;
      vertical-align: middle;
      font-weight: bold;
    }
    .currency-entry {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    .currency-entry input {
      flex: 1;
    }
    .currency-entry button {
      flex: 0 0 auto;
    }
    .currency-group {
      margin-bottom: 1rem;
      border: 1px dashed #ccc;
      padding: 0.5rem;
      background: #fdfdfd;
    }
  </style>
</head>
<body>
  <h1>GW2 Gear Admin Tool <small style="font-size: 0.6em; color: #666;">v1.4</small></h1>
  <p>Use this form to generate JSON entries for your <code>gearData.json</code>.</p>

  <label for="itemId">GW2 Item ID</label>
  <input type="text" id="itemId" placeholder="e.g. 92779" oninput="fetchItemData()">
  <div>
    <img id="iconPreview" src="" alt="Icon preview" style="display: none;">
    <span id="itemNameDisplay"></span>
    <span id="itemDetails" style="margin-left: 1rem; color: #666; font-size: 0.9em;"></span>
  </div>

  <label for="method">Method</label>
  <input type="text" id="method" placeholder="e.g. Crafting">

  <label for="description">Description (optional)</label>
  <textarea id="description" rows="2" placeholder="Craftable with Armorsmith 500"></textarea>

  <label>Cost (complex format)</label>
  <div id="costBuilder"></div>
  <button type="button" onclick="addCurrencyGroup()">+ Add Cost Option</button>
  <button type="button" onclick="addTPEntry()">+ Use TP:<Item ID> as cost</button>

  <label for="link">Wiki or Reference Link</label>
  <input type="text" id="link" placeholder="Auto-fetched or enter manually">

  <button onclick="generateJSON()">Generate JSON</button>
  <button onclick="copyJSON()">Copy to Clipboard</button>

  <pre id="output"></pre>

  <template id="currencyTemplate">
    <div class="currency-entry">
      <input type="text" placeholder="Currency (e.g. Coin)" class="currency">
      <input type="number" placeholder="Amount" class="amount">
      <button type="button" onclick="removeCurrency(this)">×</button>
    </div>
  </template>

  <script>
    let fetchedIcon = "";
    let fetchedSlot = "";
    let allAttributes = [];
    let currentRarity = "";
    let currentWeight = "";

    async function fetchItemData() {
      const itemId = document.getElementById('itemId').value.trim();
      const iconImg = document.getElementById('iconPreview');
      const nameDisplay = document.getElementById('itemNameDisplay');
      allAttributes = [];
      currentRarity = "";
      currentWeight = "";
      if (!itemId) return;

      try {
        const res = await fetch(`https://api.guildwars2.com/v2/items/${itemId}?lang=en`);
        const data = await res.json();

        fetchedIcon = data.icon || "";
        currentRarity = data.rarity || "";
        if (data.details?.weight_class) {
          currentWeight = data.details.weight_class;
        }

        nameDisplay.textContent = data.name || "";
        const itemDetails = document.getElementById('itemDetails');
        itemDetails.textContent = `${currentRarity}${currentWeight ? ' • ' + currentWeight : ''}`;
        if (fetchedIcon) {
          iconImg.src = fetchedIcon;
          iconImg.style.display = 'inline';
        } else {
          iconImg.style.display = 'none';
        }

        if (data.details?.type) {
          fetchedSlot = data.details.type;
        } else if (data.type) {
          fetchedSlot = data.type;
        } else {
          fetchedSlot = '';
        }

        if (data.details?.stat_choices) {
          const statIds = data.details.stat_choices.join(',');
          const statRes = await fetch(`https://api.guildwars2.com/v2/itemstats?ids=${statIds}`);
          const statData = await statRes.json();
          allAttributes = statData.map(s => s.id.toString());
        } else if
