<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GW2 Gear Admin Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f8f8f8;
      padding: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, textarea, select, button {
      padding: 0.5rem;
      margin-top: 0.25rem;
    }
    input, textarea {
      width: 100%;
    }
    pre {
      background: #eee;
      padding: 1rem;
      margin-top: 2rem;
      white-space: pre-wrap;
    }
    #iconPreview {
      margin-top: 0.5rem;
      max-width: 64px;
      height: auto;
      vertical-align: middle;
    }
    #itemNameDisplay {
      display: inline-block;
      margin-left: 0.5rem;
      vertical-align: middle;
      font-weight: bold;
    }
    .currency-entry {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    .currency-entry input.currency {
      width: 60%;
    }
    .currency-entry input.amount {
      width: 30%;
    }
    .currency-entry button {
      width: 10%;
      padding: 0.2rem;
    }
    .currency-group {
      margin-bottom: 1rem;
      border: 1px dashed #ccc;
      padding: 0.5rem;
      background: #fdfdfd;
      position: relative;
    }
    .currency-group .remove-group {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      font-size: 1rem;
      padding: 0.2rem 0.4rem;
    }
  </style>
</head>
<body>
  <h1>GW2 Gear Admin Tool</h1>

  <label for="itemId">GW2 Item ID</label>
  <input type="text" id="itemId" placeholder="e.g. 92779">
  <div>
    <img id="iconPreview" src="" alt="Icon preview" style="display: none;">
    <span id="itemNameDisplay"></span>
    <span id="itemDetails" style="margin-left: 1rem; color: #666; font-size: 0.9em;"></span>
  </div>

  <label for="method">Method</label>
  <input type="text" id="method" placeholder="e.g. TP, Crafting, Vendor">

  <label for="description">Description (optional)</label>
  <textarea id="description" rows="2" placeholder="Craftable with Armorsmith 500"></textarea>

  <label>Cost (complex format)</label>
  <div id="costBuilder"></div>
  <button id="addGroupBtn" type="button">+ Add Cost Option</button>
  <button id="addTPBtn" type="button">+ Use TP:<Item ID> as cost</button>
  <button id="addCraftBtn" type="button">+ Use Crafting:&lt;Item ID&gt; as cost</button>

  <label for="link">Wiki or Reference Link</label>
  <input type="text" id="link" placeholder="Auto-fetched or enter manually">

  <button id="generateBtn">Generate JSON</button>
  <button id="copyBtn">Copy to Clipboard</button>

  <pre id="output"></pre>

  <template id="currencyTemplate">
    <div class="currency-entry">
      <input type="text" placeholder="Currency (e.g. Coin)" class="currency">
      <input type="number" placeholder="Amount" class="amount">
      <button type="button" class="removeBtn">×</button>
    </div>
  </template>

  <script>
    let fetchedIcon = "";
    let fetchedSlot = "";
    let allAttributes = [];
    let currentRarity = "";
    let currentWeight = "";

    async function fetchItemData() {
      const itemId = document.getElementById('itemId').value.trim();
      const iconImg = document.getElementById('iconPreview');
      const nameDisplay = document.getElementById('itemNameDisplay');
      allAttributes = [];
      currentRarity = "";
      currentWeight = "";
      if (!itemId) return;

      try {
        const res = await fetch(`https://api.guildwars2.com/v2/items/${itemId}?lang=en`);
        const data = await res.json();

        fetchedIcon = data.icon || "";
        currentRarity = data.rarity || "";
        currentWeight = data.details?.weight_class || "";

        nameDisplay.textContent = data.name || "";
        const itemDetails = document.getElementById('itemDetails');
        itemDetails.textContent = `${currentRarity}${currentWeight ? ' • ' + currentWeight : ''}`;
        if (fetchedIcon) {
          iconImg.src = fetchedIcon;
          iconImg.style.display = 'inline';
        } else {
          iconImg.style.display = 'none';
        }

        fetchedSlot = data.details?.type || data.type || "";

        if (data.details?.stat_choices) {
          const statIds = data.details.stat_choices.join(',');
          const statRes = await fetch(`https://api.guildwars2.com/v2/itemstats?ids=${statIds}`);
          const statData = await statRes.json();
          allAttributes = statData.map(s => s.id.toString());
        } else if (data.details?.infix_upgrade?.id) {
          allAttributes = [data.details.infix_upgrade.id.toString()];
        }

        await autoFillWikiLink();
      } catch (err) {
        console.error("Item fetch failed:", err);
      }
    }

    function addCurrencyGroup() {
      const container = document.getElementById("costBuilder");
      const groupDiv = document.createElement("div");
      groupDiv.className = "currency-group";

      const removeBtn = document.createElement("button");
      removeBtn.textContent = "×";
      removeBtn.className = "remove-group";
      removeBtn.type = "button";
      removeBtn.addEventListener("click", () => groupDiv.remove());
      groupDiv.appendChild(removeBtn);

      const addBtn = document.createElement("button");
      addBtn.textContent = "+ Currency";
      addBtn.type = "button";
      addBtn.onclick = () => addCurrencyEntry(groupDiv);
      groupDiv.appendChild(addBtn);

      container.appendChild(groupDiv);
      addCurrencyEntry(groupDiv);
    }

    function addCurrencyEntry(groupDiv) {
      const template = document.getElementById("currencyTemplate");
      const clone = template.content.cloneNode(true);
      const entry = clone.querySelector('.currency-entry');
      entry.querySelector('.removeBtn').addEventListener('click', () => entry.remove());
      groupDiv.insertBefore(entry, groupDiv.lastChild);
    }

    function addTPEntry() {
      const itemId = document.getElementById('itemId').value.trim();
      if (!itemId) {
        alert("Enter a valid item ID first.");
        return;
      }
      document.getElementById("costBuilder").innerHTML = '';

      const container = document.getElementById("costBuilder");
      const groupDiv = document.createElement("div");
      groupDiv.className = "currency-group";

      const removeBtn = document.createElement("button");
      removeBtn.textContent = "×";
      removeBtn.className = "remove-group";
      removeBtn.type = "button";
      removeBtn.addEventListener("click", () => groupDiv.remove());
      groupDiv.appendChild(removeBtn);

      const entryDiv = document.createElement("div");
      entryDiv.className = "currency-entry";

      const input = document.createElement("input");
      input.className = "currency";
      input.value = `TP:${itemId}`;
      input.placeholder = "Currency (e.g. Coin)";
      entryDiv.appendChild(input);

      const dummy = document.createElement("input");
      dummy.className = "amount";
      dummy.type = "number";
      dummy.value = 0;
      dummy.placeholder = "Amount";
      entryDiv.appendChild(dummy);

      const removeCurrencyBtn = document.createElement("button");
      removeCurrencyBtn.textContent = "×";
      removeCurrencyBtn.type = "button";
      removeCurrencyBtn.addEventListener("click", () => entryDiv.remove());
      entryDiv.appendChild(removeCurrencyBtn);

      groupDiv.appendChild(entryDiv);
      container.appendChild(groupDiv);
    }

    function addCraftEntry() {
  const itemId = document.getElementById('itemId').value.trim();
  if (!itemId) {
    alert("Enter a valid item ID first.");
    return;
  }
  document.getElementById("costBuilder").innerHTML = '';

  const container = document.getElementById("costBuilder");
  const groupDiv = document.createElement("div");
  groupDiv.className = "currency-group";

  const removeBtn = document.createElement("button");
  removeBtn.textContent = "×";
  removeBtn.className = "remove-group";
  removeBtn.type = "button";
  removeBtn.addEventListener("click", () => groupDiv.remove());
  groupDiv.appendChild(removeBtn);

  const entryDiv = document.createElement("div");
  entryDiv.className = "currency-entry";

  const input = document.createElement("input");
  input.className = "currency";
  input.value = `craft:${itemId}`;
  input.placeholder = "Currency (e.g. Coin)";
  entryDiv.appendChild(input);

  const dummy = document.createElement("input");
  dummy.className = "amount";
  dummy.type = "number";
  dummy.value = 0;
  dummy.placeholder = "Amount";
  entryDiv.appendChild(dummy);

  const removeCurrencyBtn = document.createElement("button");
  removeCurrencyBtn.textContent = "×";
  removeCurrencyBtn.type = "button";
  removeCurrencyBtn.addEventListener("click", () => entryDiv.remove());
  entryDiv.appendChild(removeCurrencyBtn);

  groupDiv.appendChild(entryDiv);
  container.appendChild(groupDiv);
}
    
    async function autoFillWikiLink() {
      const itemId = document.getElementById('itemId').value.trim();
      const linkField = document.getElementById('link');
      if (!itemId) return;
      try {
        const res = await fetch(`https://api.guildwars2.com/v2/items/${itemId}?lang=en`);
        const data = await res.json();
        const name = data.name?.replace(/\s/g, '_').replace(/'/g, '%27');
        if (name) {
          linkField.value = `https://wiki.guildwars2.com/wiki/${name}`;
        }
      } catch (e) {
        console.warn("Wiki fetch failed", e);
      }
    }

    function generateJSON() {
      const slot = fetchedSlot;
      const itemId = document.getElementById('itemId').value.trim();
      const iconUrl = document.getElementById('iconPreview').src;
      const method = document.getElementById('method').value.trim();
      const description = document.getElementById('description').value.trim();
      const link = document.getElementById('link').value.trim();

      let cost;
      const costGroups = Array.from(document.querySelectorAll('.currency-group')).map(group => {
        const entries = Array.from(group.querySelectorAll('.currency-entry')).map(entry => {
          const currency = entry.querySelector('.currency')?.value.trim();
          const amountRaw = entry.querySelector('.amount')?.value;
          const amount = amountRaw === "" ? 0 : parseInt(amountRaw, 10);
          return (currency) ? { currency, amount: isNaN(amount) ? 0 : amount } : null;
        }).filter(Boolean);
        return entries.length > 0 ? entries : null;
      }).filter(Boolean);

      if (
        costGroups.length === 1 &&
        costGroups[0].length === 1 &&
        costGroups[0][0].currency.startsWith("TP:") || costGroups[0][0].currency.startsWith("craft:"))
      ) {
        cost = costGroups[0][0].currency;
      } else {
        cost = costGroups.length > 0 ? costGroups : undefined;
      }

      if (!slot || !itemId || !method) {
        document.getElementById('output').textContent = 'Slot, item ID, and method are required.';
        return;
      }

      const entry = {
        name: itemId,
        icon: iconUrl || undefined,
        rarity: currentRarity || undefined,
        weight_class: currentWeight || undefined,
        method: method,
        cost: cost,
        link: link,
        attributes: allAttributes
      };
      if (description) entry.description = description;
      if (!entry.weight_class) delete entry.weight_class;

      const json = { [slot]: [entry] };
      document.getElementById('output').textContent = JSON.stringify(json, null, 2);
    }

    function copyJSON() {
      const output = document.getElementById('output');
      if (output.textContent.trim() !== '') {
        navigator.clipboard.writeText(output.textContent)
          .then(() => alert('JSON copied to clipboard!'))
          .catch(() => alert('Failed to copy JSON.'));
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("itemId").addEventListener("input", fetchItemData);
      document.getElementById("addGroupBtn").addEventListener("click", addCurrencyGroup);
      document.getElementById("addTPBtn").addEventListener("click", addTPEntry);
      document.getElementById("generateBtn").addEventListener("click", generateJSON);
      document.getElementById("copyBtn").addEventListener("click", copyJSON);
      document.getElementById("addCraftBtn").addEventListener("click", addCraftEntry);
    });
  </script>
</body>
</html>
