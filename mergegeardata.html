<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Merge gearData.json with Live Currency Check</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    textarea, pre, button {
      width: 100%;
      margin-top: 1rem;
      padding: 1rem;
      font-family: monospace;
    }
    textarea {
      height: 200px;
    }
    pre {
      background: #eee;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Extend gearData.json <small style="font-size: 0.6em; color: #666;">v1.5</small></h1>
  <p>Paste your existing gearData.json in the first box, and new blocks below. Items will be fully replaced. Currencies will be validated live.</p>

  <h3>Existing gearData.json</h3>
  <textarea id="base" placeholder="Paste full existing gearData.json here..."></textarea>

  <h3>New JSON Blocks</h3>
  <textarea id="input" placeholder="Paste one or more new JSON blocks here..."></textarea>

  <button onclick="mergeBlocks()">Merge and Overwrite</button>
  <button onclick="clearBaseField()">Clear Existing Data</button>
  <button onclick="copyOutput()">Copy Merged JSON</button>
  <pre id="output"></pre>

  <script>
    async function mergeBlocks() {
      const base = document.getElementById('base').value.trim();
      const input = document.getElementById('input').value.trim();
      const output = document.getElementById('output');

      try {
        const baseData = JSON.parse(base);

        let newBlocks;
        try {
          const single = JSON.parse(input);
          newBlocks = [single];
        } catch {
          newBlocks = input
            .split(/(?<=\})\s*(?=\{)/g)
            .map(b => JSON.parse(b));
        }

        const currencyMapUrl = "https://raw.githubusercontent.com/Malimani/gw2gear/main/currencyIconMap.json";
        const currencyMap = await fetch(currencyMapUrl).then(res => res.json());
        const knownCurrencies = new Set(Object.keys(currencyMap));
        const unknownCurrencyMap = {};

        for (const block of newBlocks) {
          for (const slot in block) {
            if (!baseData[slot]) baseData[slot] = [];

            const existing = baseData[slot];
            const updates = block[slot];

            for (const newItem of updates) {
              if (Array.isArray(newItem.cost)) {
                newItem.cost.flat().forEach(c => {
                  if (c.currency && !knownCurrencies.has(c.currency)) {
                    if (!unknownCurrencyMap[c.currency]) {
                      unknownCurrencyMap[c.currency] = new Set();
                    }
                    unknownCurrencyMap[c.currency].add(newItem.name);
                  }
                });
              }

              const index = existing.findIndex(e => e.name === newItem.name);
              if (index >= 0) {
                for (const key in existing[index]) delete existing[index][key];
                Object.assign(existing[index], newItem);
              } else {
                existing.push(newItem);
              }
            }
          }
        }

        let result = JSON.stringify(baseData, null, 2);
        const unknowns = Object.entries(unknownCurrencyMap);
        if (unknowns.length > 0) {
          result += "\n\n⚠️ Unknown currencies used:\n";
          for (const [cur, ids] of unknowns) {
            result += `- ${cur}: ${Array.from(ids).join(", ")}\n`;
          }
        }

        output.textContent = result;
      } catch (e) {
        output.textContent = '⚠️ Error merging data: ' + e.message;
      }
    }

    function clearBaseField() {
      document.getElementById('base').value = '';
    }

    function copyOutput() {
      const output = document.getElementById('output').textContent;
      if (output.trim() !== '') {
        navigator.clipboard.writeText(output)
          .then(() => alert('Merged JSON copied to clipboard!'))
          .catch(() => alert('Failed to copy.'));
      }
    }
  </script>
</body>
</html>
